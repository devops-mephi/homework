# Blue green deploy

На прошлом занятии мы остановились на схеме деплоя через ansible, которая обладает одним существенным недостатком: во время обновления сервис перестает работать и отдает ошибки 5xx.
Это неприемлимо.
Одним из способов решения данной проблемы (обновление без прекращения в обслуживании) является метод blue-green деплоя.
В чем его суть:
Одновременно на сервере развернуты две копии сервиса: "blue" и "green". Одна из них является продакшеном и на неё роутятся запросы пользователей. Далее при деплое обновляется другая копия. После этого проверяется, работает ли она и только после этого запросы перенаправляются на эту копию.

Попробуем реализовать такую схему.

1. Начнем с поднятия машин ansible_main и ansible_slave

2. Переместим пока tasks, что получились на прошлом занятии, чтобы начать всё заново

```
[vagrant@localhost ~]$ cd ansible/
[vagrant@localhost ansible]$ mv roles/banners/tasks/main.yml roles/banners/tasks/main.yml.old
```

3. Начнем писать новую последовательность действий, начав с определения текущей продакшен-копии.

```
[vagrant@localhost ansible]$ vi roles/banners/tasks/main.yml
```

Будем хранить цвет текущей продакшен-копии в файле /etc/banners_color. Перед тем как что-то делать, нужно проверить, что файл такой вообще есть.

```
---
- name: Check that the /etc/banners_color exists
  stat:
    path: /etc/banners_color
  register: color_file_stat
```
Теперь в следующих задачах мы можем проверять, есть ли такой файл.

4. Если файла нет, то будем считать, что цвет - blue.

```
- name: If it does not exists then it is blue
  set_fact:
    production_color: blue
  when:
    color_file_stat.stat.exists == False
```
